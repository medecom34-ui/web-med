generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// *
/// * ---------- Core ----------
model User {
  id        BigInt   @id @default(autoincrement())
  email     String   @unique
  password  String   @map("password_hash") @db.VarChar(255)
  fullName  String
  phone     String?  @db.VarChar(50)
  role      Role     @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Category {
  id          BigInt     @id @default(autoincrement())
  parentId    BigInt?
  slug        String     @unique
  name        String
  description String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  imageUrl    String?    @db.VarChar(500)
  parent      Category?  @relation("CategoryToParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToParent")
  products    Product[]

  @@index([parentId])
  @@index([isActive, sortOrder])
}

model Product {
  id         BigInt           @id @default(autoincrement())
  slug       String           @unique
  name       String
  brand      String?
  shortDesc  String?
  longDesc   String?   @db.LongText
  isActive   Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @default(now()) @updatedAt
  categoryId BigInt?
  orderItems OrderItem[]
  category   Category?        @relation(fields: [categoryId], references: [id])
  media      ProductMedia[]
  variants   ProductVariant[]

  @@index([isActive])
  @@index([categoryId])
}

model ProductVariant {
  id             BigInt      @id @default(autoincrement())
  productId      BigInt
  sku            String      @unique @db.VarChar(64)
  attributesJson Json?
  price          Decimal     @default(0.00) @db.Decimal(10, 2)
  currency       String      @default("THB") @db.Char(3)
  isActive       Boolean     @default(true)
  onHand         Int         @default(0)
  reserved       Int         @default(0)
  orderItems     OrderItem[]
  product        Product     @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([isActive])
}

model ProductMedia {
  id        BigInt    @id @default(autoincrement())
  productId BigInt
  url       String    @db.VarChar(1000)
  altText   String?   @db.VarChar(255)
  type      MediaType @default(IMAGE)
  sortOrder Int       @default(0)
  product   Product   @relation(fields: [productId], references: [id])

  @@index([productId, sortOrder])
}

/// *
/// * ---------- Orders ----------
model OrderSequence {
  day String @id @db.VarChar(10)
  seq Int    @default(0)
}

model Order {
  id          BigInt         @id @default(autoincrement())
  orderNumber String         @unique(map: "Order_orderNumber_key") @db.VarChar(32)
  userId      BigInt?
  status      OrderStatus    @default(PENDING)
  subtotal    Decimal        @db.Decimal(10, 2)
  shippingFee Decimal        @default(0.00) @db.Decimal(10, 2)
  taxTotal    Decimal        @default(0.00) @db.Decimal(10, 2)
  grandTotal  Decimal        @db.Decimal(10, 2)
  placedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  addresses   OrderAddress[]
  items       OrderItem[]
  payments    Payment[]
  shipments   Shipment[]
  user        User?          @relation(fields: [userId], references: [id], map: "Order_userId_fkey")

  @@index([userId, placedAt], map: "Order_userId_placedAt_idx")
  @@map("orders")
}

model OrderItem {
  id           BigInt         @id @default(autoincrement())
  orderId      BigInt
  productId    BigInt
  variantId    BigInt
  nameSnapshot String         @db.VarChar(255)
  skuSnapshot  String         @db.VarChar(64)
  qty          Int
  unitPrice    Decimal        @db.Decimal(10, 2)
  lineTotal    Decimal        @db.Decimal(10, 2)
  order        Order          @relation(fields: [orderId], references: [id])
  product      Product        @relation(fields: [productId], references: [id])
  variant      ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId], map: "OrderItem_productId_fkey")
  @@index([variantId], map: "OrderItem_variantId_fkey")
}

/// *
/// * ---------- Checkout snapshots & payments ----------
model OrderAddress {
  id          BigInt      @id @default(autoincrement())
  orderId     BigInt
  type        AddressType
  fullName    String
  phone       String      @db.VarChar(50)
  line1       String      @db.VarChar(255)
  subdistrict String
  district    String
  province    String
  postcode    String      @db.VarChar(20)
  countryCode String      @default("TH") @db.Char(2)
  order       Order       @relation(fields: [orderId], references: [id])

  @@index([orderId, type])
}

model Payment {
  id         BigInt        @id @default(autoincrement())
  orderId    BigInt
  status     PaymentStatus @default(PENDING)
  amount     Decimal       @db.Decimal(10, 2)
  createdAt  DateTime      @default(now())
  payerName  String?
  slipUrl    String?
  updatedAt  DateTime      @updatedAt
  verifiedAt DateTime?
  verifiedBy BigInt?
  order      Order         @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model Shipment {
  id         BigInt    @id @default(autoincrement())
  orderId    BigInt
  carrier    String
  service    String?
  trackingNo String?
  status     String?   @db.VarChar(50)
  shippedAt  DateTime?
  labelUrl   String?
  order      Order     @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([trackingNo])
}



/// * ---------- Enums ----------
enum Role {
  CUSTOMER
  ADMIN
}

enum MediaType {
  IMAGE
  PDF
  VIDEO
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLING
  SHIPPED
  COMPLETED
  CANCELED
}

enum AddressType {
  SHIPPING
  BILLING
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum Order_backup_status {
  PENDING
  PAID
  FULFILLING
  SHIPPED
  COMPLETED
  CANCELED
}
